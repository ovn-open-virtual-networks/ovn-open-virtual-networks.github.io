<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="简介
2024年04月08日15:23，腾讯云团队收到监控告警，出现大面积登录不了腾讯云控制台故障。腾讯云4月8日故障复盘及情况说明
影响
依赖云API服务的部分公有云服务无法使用，比如云函数、文字识别、微服务平台、音频内容安全、验证码等。此次故障一共持续了近87分钟，期间共有1957个客户报障。
根因


本次API升级过程中，由于新版本的接口协议发生了变化，在后台发布新版本之后对于旧版本前端传来的数据处理逻辑异常，导致生成了一条错误的配置数据，由于灰度机制不足导致异常数据快速扩散到了全网地域，造成整体API使用异常。
发生故障后，按照标准回滚方案将服务后台和配置数据同时回滚到旧版本，并重启API后台服务，但此时因为承载API服务的容器平台也依赖API服务才能提供调度能力，即发生了循环依赖，导致服务无法自动拉起。通过运维手工启动方式才使API服务重启，完成整个故障恢复。


故障修复

15:23 监测到故障，立即执行服务的恢复，同时进行原因的排查；
15:47 发现通过回滚版本没能完全恢复服务，进一步定位问题；
15:57 定位出故障根因是配置数据出现错误，紧急设计数据修复方案；
16:02 对全地域进行数据修复工作，API服务逐地域恢复中；
16:05 观测到除上海外的地域API服务均已恢复，进一步定位上海地域的恢复问题；
16:25 定位到上海的技术组件存在API循环依赖问题，决定通过流量调度至其他地域来恢复；
16:45 观测到上海地域恢复了，此时API和依赖API的PaaS服务彻底恢复，但控制台流量剧增，按九倍容量进行了扩容；
16:50 请求量逐渐恢复到正常水平，业务稳定运行，控制台服务全部恢复；
17:45 持续观察一小时，未发现问题，按预案处理过程完毕。

预防措施
官方虽然给出了后续的改进措施，但根据作者的一些理解，改进还远远不够。下面是作者的一些思索：

灰度，监控
循环依赖
架构一致性
API 前后兼容性
">  

  <title>
    
      2024-04-08 腾讯云API服务故障解析复盘
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.236b16ba4684fc5e57068c7e1f5e5e9e39f4c020ef112211f513239629a178eaf17522fce9a1ded3aa072e6a29ce6d433fceb359983c7d8d185ed13fcb3f4cee.css" integrity="sha512-I2sWukaE/F5XBox&#43;H15enjn0wCDvESIR9RMjlimheOrxdSL86aHe06oHLmopzm1DP86zWZg8fY0YXtE/yz9M7g==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
                <div class="post-meta">
                    <a href="/">..</a>

                    <p>
                        <time datetime="2024-04-15 22:52:57 -0500 -0500">
                            2024-04-15
                        </time>
                    </p>
                </div>

<article>
    <h1>2024-04-08 腾讯云API服务故障解析复盘</h1>

    
        <aside  class="toc" >
            <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#影响">影响</a></li>
    <li><a href="#根因">根因</a></li>
    <li><a href="#故障修复">故障修复</a></li>
    <li><a href="#预防措施">预防措施</a></li>
  </ul>
</nav>
        </aside>
    

    <h2 id="简介">简介</h2>
<p>2024年04月08日15:23，腾讯云团队收到监控告警，出现大面积登录不了腾讯云控制台故障。<a href="https://cloud.tencent.com/developer/article/2408984">腾讯云4月8日故障复盘及情况说明</a></p>
<h2 id="影响">影响</h2>
<p>依赖云API服务的部分公有云服务无法使用，比如云函数、文字识别、微服务平台、音频内容安全、验证码等。此次故障一共持续了近87分钟，期间共有1957个客户报障。</p>
<h2 id="根因">根因</h2>
<blockquote>
<ol>
<li>本次API升级过程中，由于新版本的接口协议发生了变化，在后台发布新版本之后对于旧版本前端传来的数据处理逻辑异常，导致生成了一条错误的配置数据，由于灰度机制不足导致异常数据快速扩散到了全网地域，造成整体API使用异常。</li>
<li>发生故障后，按照标准回滚方案将服务后台和配置数据同时回滚到旧版本，并重启API后台服务，但此时因为承载API服务的容器平台也依赖API服务才能提供调度能力，即发生了循环依赖，导致服务无法自动拉起。通过运维手工启动方式才使API服务重启，完成整个故障恢复。</li>
</ol>
</blockquote>
<h2 id="故障修复">故障修复</h2>
<blockquote>
<p>15:23 监测到故障，立即执行服务的恢复，同时进行原因的排查；<br>
15:47 发现通过回滚版本没能完全恢复服务，进一步定位问题；<br>
15:57 定位出故障根因是配置数据出现错误，紧急设计数据修复方案；<br>
16:02 对全地域进行数据修复工作，API服务逐地域恢复中；<br>
16:05 观测到除上海外的地域API服务均已恢复，进一步定位上海地域的恢复问题；<br>
16:25 定位到上海的技术组件存在API循环依赖问题，决定通过流量调度至其他地域来恢复；<br>
16:45 观测到上海地域恢复了，此时API和依赖API的PaaS服务彻底恢复，但控制台流量剧增，按九倍容量进行了扩容；<br>
16:50 请求量逐渐恢复到正常水平，业务稳定运行，控制台服务全部恢复；<br>
17:45 持续观察一小时，未发现问题，按预案处理过程完毕。</p>
</blockquote>
<h2 id="预防措施">预防措施</h2>
<p><em>官方虽然给出了后续的改进措施，但根据作者的一些理解，改进还远远不够。下面是作者的一些思索：</em></p>
<ol>
<li>灰度，监控</li>
<li>循环依赖</li>
<li>架构一致性</li>
<li>API 前后兼容性</li>
</ol>

</article>

            </div>
        </main>
    </body></html>
